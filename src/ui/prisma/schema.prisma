generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  SUPER_USER
  ORGANIZATION_ADMIN
  COLLECTION_ADMIN
  USER
}

enum MembershipRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum CollectionVisibility {
  PRIVATE
  PUBLIC
}

enum JobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
}

model User {
  id            String                   @id @default(uuid()) @db.Uuid
  email         String                   @unique
  name          String?
  password      String?
  role          Role                     @default(USER)
  organizations OrganizationMembership[]
  collections   CollectionMembership[]
  contents      Content[]                @relation("UploaderContent")
  createdAt     DateTime                 @default(now())
  updatedAt     DateTime                 @updatedAt
}

model Organization {
  id             String                   @id @default(uuid()) @db.Uuid
  name           String
  slug           String                   @unique
  description    String?
  collections    Collection[]
  memberships    OrganizationMembership[]
  contents       Content[]
  approvedEmails ApprovedEmail[]
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt
}

model OrganizationMembership {
  id             String         @id @default(uuid()) @db.Uuid
  userId         String         @db.Uuid
  organizationId String         @db.Uuid
  role           MembershipRole @default(VIEWER)
  createdAt      DateTime       @default(now())

  organization Organization @relation(fields: [organizationId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@unique([userId, organizationId])
}

model Collection {
  id             String               @id @default(uuid()) @db.Uuid
  name           String
  description    String?
  organizationId String               @db.Uuid
  visibility     CollectionVisibility @default(PRIVATE)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  organization Organization           @relation(fields: [organizationId], references: [id])
  contents     Content[]
  memberships  CollectionMembership[]
}

model CollectionMembership {
  id           String         @id @default(uuid()) @db.Uuid
  collectionId String         @db.Uuid
  userId       String         @db.Uuid
  role         MembershipRole @default(VIEWER)
  createdAt    DateTime       @default(now())

  collection Collection @relation(fields: [collectionId], references: [id])
  user       User       @relation(fields: [userId], references: [id])

  @@unique([collectionId, userId])
}

model Content {
  id                    String    @id @default(uuid()) @db.Uuid
  title                 String
  description           String?
  videoUrl              String
  organizationId        String    @db.Uuid
  collectionId          String    @db.Uuid
  uploadedById          String    @db.Uuid
  actionSummaryStatus   JobStatus @default(QUEUED)
  chapterAnalysisStatus JobStatus @default(QUEUED)
  analysisRequestedAt   DateTime?
  processingMetadata    Json?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id])
  collection   Collection   @relation(fields: [collectionId], references: [id])
  uploadedBy   User         @relation("UploaderContent", fields: [uploadedById], references: [id])
}

model ApprovedEmail {
  id             String   @id @default(uuid()) @db.Uuid
  email          String   @unique
  organizationId String?  @db.Uuid
  collectionIds  String[]
  role           Role     @default(USER)
  createdAt      DateTime @default(now())

  organization Organization? @relation(fields: [organizationId], references: [id])
}
